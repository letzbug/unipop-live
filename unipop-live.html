<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>UniPop Live</title>
<style>
  html,body{margin:0;padding:0;overflow:hidden;background:#eef6f9;color:#082b49;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .stage{position:relative;width:100vw;max-width:1200px;margin:0 auto}
  .ratio{position:relative;width:100%;padding-top:56.25%;border-radius:16px;overflow:hidden;background:#000}
  .badge{position:absolute;top:12px;left:12px;background:#e60000;color:#fff;padding:.25rem .5rem;border-radius:999px;font-size:.85rem;font-weight:700;letter-spacing:.3px}
  .poster,.wrap{position:absolute;inset:0}
  .poster{background:#000 center/contain no-repeat}
  .hidden{display:none!important}
  .wrap{display:block}
  .wrap iframe{position:absolute;inset:0;width:100%;height:100%;border:0;display:block}
</style>
</head>
<body>
  <div class="stage">
    <div class="ratio">
      <div id="badge" class="badge">EN DIRECT</div>
      <div id="poster" class="poster"></div>

      <!-- PrimÃ¤rer Player (YT Iframe API) -->
      <div id="playerWrap" class="wrap hidden">
        <div id="playerMount"></div>
      </div>

      <!-- Fallback: direkter YouTube-Embed (ohne API) -->
      <div id="fallbackWrap" class="wrap hidden"></div>
    </div>
  </div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const VIDEO_ID = qs.get('video') || '';
  const POSTER   = qs.get('poster') || '';
  const AUTOPLAY = qs.get('autoplay') === '1';
  const MUTE     = qs.get('mute') !== '0';
  const PREROLL  = Math.max(0, parseInt(qs.get('preroll') || '3000'));

  const posterEl   = document.getElementById('poster');
  const playerWrap = document.getElementById('playerWrap');
  const fallbackWrap = document.getElementById('fallbackWrap');

  if (POSTER) posterEl.style.backgroundImage = `url("${POSTER}")`;

  let player, hasPlayed = false, watchdogTimer = null;

  function showPoster(){ posterEl.classList.remove('hidden'); playerWrap.classList.add('hidden'); fallbackWrap.classList.add('hidden'); }
  function showPlayer(){ posterEl.classList.add('hidden'); playerWrap.classList.remove('hidden'); fallbackWrap.classList.add('hidden'); }
  function showFallback(){ posterEl.classList.add('hidden'); playerWrap.classList.add('hidden'); fallbackWrap.classList.remove('hidden'); }

  // Build fallback iframe (no-cookie + permissions)
  function mountFallback(){
    if (fallbackWrap.firstChild) return; // already mounted
    const u = new URL(`https://www.youtube-nocookie.com/embed/${encodeURIComponent(VIDEO_ID)}`);
    u.searchParams.set('autoplay', AUTOPLAY ? '1' : '0');
    u.searchParams.set('mute', MUTE ? '1' : '0');
    u.searchParams.set('rel','0');
    u.searchParams.set('modestbranding','1');
    u.searchParams.set('playsinline','1');
    u.searchParams.set('enablejsapi','1');

    const ifr = document.createElement('iframe');
    ifr.src = u.toString();
    ifr.allow = 'autoplay; encrypted-media; picture-in-picture; fullscreen';
    ifr.setAttribute('allowfullscreen','');
    fallbackWrap.appendChild(ifr);
  }

  function startWatchdog(){
    clearTimeout(watchdogTimer);
    // Wenn innerhalb 4,5s kein PLAYING erreicht -> Fallback
    watchdogTimer = setTimeout(()=>{
      if (!hasPlayed){
        mountFallback();
        showFallback();
      }
    }, 4500);
  }

  function loadYT(){
    if(window.YT && window.YT.Player){ initYT(); return; }
    const s=document.createElement('script');
    s.src='https://www.youtube.com/iframe_api';
    document.head.appendChild(s);
    window.onYouTubeIframeAPIReady = initYT;
  }

  function initYT(){
    player = new YT.Player('playerMount',{
      host:'https://www.youtube-nocookie.com',
      videoId: VIDEO_ID,
      playerVars:{
        autoplay: AUTOPLAY?1:0,
        playsinline:1,
        rel:0,
        modestbranding:1,
        controls:1,
        mute:MUTE?1:0,
        origin:location.origin,
        enablejsapi:1
      },
      events:{ onReady:onReady, onStateChange:onState, onError:onError }
    });
  }

  function onReady(){
    setTimeout(()=>{
      try{
        if(MUTE && player.mute) player.mute();
        if(AUTOPLAY && player.playVideo) player.playVideo();
        showPlayer();
        startWatchdog();
      }catch(e){
        mountFallback();
        showFallback();
      }
    }, PREROLL);
  }

  function onState(e){
    const S = YT.PlayerState;
    if(e.data === S.PLAYING){
      hasPlayed = true;
      clearTimeout(watchdogTimer);
      showPlayer();
    }
    if(e.data === S.ENDED){
      hasPlayed = false;
      showPoster();
    }
  }

  function onError(){
    mountFallback();
    showFallback();
  }

  showPoster();
  loadYT();
})();
</script>
</body>
</html>

</html>
