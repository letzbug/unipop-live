<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const VIDEO_ID = qs.get('video') || '';
  const ISO_START = qs.get('start') || '';
  const POSTER = qs.get('poster') || '';
  const AUTOPLAY = qs.get('autoplay') === '1';
  const MUTE = qs.get('mute') !== '0';
  const PREROLL = Math.max(0, parseInt(qs.get('preroll') || '3000')); // ms

  const badge = document.getElementById('badge');
  const labelEl = document.getElementById('label');
  const countEl = document.getElementById('count');
  const posterEl = document.getElementById('poster');
  const playerBox = document.getElementById('playerBox');

  let startTime = ISO_START ? new Date(ISO_START) : null;
  let player, prerollDone = false, endedForever = false;
  let watchdogInt = null;

  if (POSTER) posterEl.style.backgroundImage = `url("${POSTER}")`;

  function showPoster(){ posterEl.classList.remove('hidden'); playerBox.classList.add('hidden'); badge.classList.add('hidden'); }
  function showPlayer(){ posterEl.classList.add('hidden'); playerBox.classList.remove('hidden'); badge.classList.remove('hidden'); }
  function setLiveUI(){ labelEl.textContent='En direct'; countEl.textContent=''; }
  function setUpcoming(ms){ labelEl.textContent='Live stream démarre dans'; countEl.textContent=ms; showPoster(); }
  function setEnded(){ labelEl.textContent='Live stream terminé — merci !'; countEl.textContent=''; showPoster(); endedForever = true; }

  function two(n){return String(n).padStart(2,'0')}
  function fmt(ms){
    if(ms<0) ms=0;
    const s=Math.floor(ms/1000), d=Math.floor(s/86400);
    const h=Math.floor((s%86400)/3600), m=Math.floor((s%3600)/60), sec=s%60;
    return (d>0?d+'j ':'')+two(h)+':'+two(m)+':'+two(sec);
  }

  function tick(){
    if(endedForever) return;
    if(!startTime){ setLiveUI(); return; }
    const diff = startTime - new Date();
    if(diff>0) setUpcoming(fmt(diff)); else setLiveUI();
  }

  function loadYT(){
    if(window.YT && window.YT.Player){ initYT(); return; }
    const s=document.createElement('script'); s.src='https://www.youtube.com/iframe_api';
    document.head.appendChild(s);
    window.onYouTubeIframeAPIReady = initYT;
  }

  function initYT(){
    player = new YT.Player('playerBox',{
      videoId: VIDEO_ID,
      playerVars:{autoplay:0, playsinline:1, rel:0, modestbranding:1, controls:1, mute:MUTE?1:0},
      events:{onReady:onReady, onStateChange:onState}
    });
  }

  function startWatchdog(){
    // Prüft bis zu 6s im 100-ms-Raster auf tatsächliches PLAYING, sonst Poster lassen
    let elapsed = 0;
    clearInterval(watchdogInt);
    watchdogInt = setInterval(()=>{
      if (!player || typeof player.getPlayerState !== 'function') return;
      const S = YT.PlayerState;
      const st = player.getPlayerState();
      if (st === S.PLAYING) {
        showPlayer(); clearInterval(watchdogInt);
      } else {
        // solange nicht PLAYING -> Poster sichtbar halten
        showPoster();
      }
      elapsed += 100;
      if (elapsed >= 6000) { // Fallback: nach 6s erneut play versuchen
        try { player.playVideo(); } catch(e){}
        elapsed = 0;
      }
    }, 100);
  }

  function onReady(){
    // 1) Poster zuerst stehen lassen
    showPoster();
    // 2) Nach PREROLL Autoplay versuchen (muted)
    setTimeout(()=>{
      prerollDone = true;
      try { if(MUTE && player.mute) player.mute(); } catch(e){}
      if (AUTOPLAY && player && player.playVideo) {
        try { player.playVideo(); } catch(e){}
      }
      // 3) Watchdog prüft, ob wirklich PLAYING -> erst dann Poster weg
      startWatchdog();
    }, PREROLL);
  }

  function onState(e){
    const S = YT.PlayerState;
    if(e.data === S.PLAYING){
      // Bestätigung: jetzt wirklich Video zeigen
      if (prerollDone) showPlayer();
    }
    if(e.data === S.BUFFERING || e.data === S.UNSTARTED){
      // niemals Schwarz zeigen -> Poster oben halten
      showPoster();
    }
    if(e.data === S.ENDED){
      setEnded();
    }
  }

  // Start
  showPoster();
  tick();
  setInterval(tick,1000);
  loadYT();
})();
</script>
