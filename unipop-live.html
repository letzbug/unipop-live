(function(){
  const qs = new URLSearchParams(location.search);
  const VIDEO_ID = qs.get('video') || '';
  const POSTER = qs.get('poster') || '';
  const AUTOPLAY = qs.get('autoplay') === '1';
  const MUTE = qs.get('mute') !== '0';
  const PREROLL = Math.max(0, parseInt(qs.get('preroll') || '3000'));

  const posterEl = document.getElementById('poster');
  const playerBox = document.getElementById('playerBox');

  if (POSTER) posterEl.style.backgroundImage = `url("${POSTER}")`;

  let player;

  function showPoster(){ posterEl.classList.remove('hidden'); playerBox.classList.add('hidden'); }
  function showPlayer(){ posterEl.classList.add('hidden'); playerBox.classList.remove('hidden'); }

  function loadYT(){
    if(window.YT && window.YT.Player){ initYT(); return; }
    const s=document.createElement('script');
    s.src='https://www.youtube.com/iframe_api';
    document.head.appendChild(s);
    window.onYouTubeIframeAPIReady = initYT;
  }

  function initYT(){
    player = new YT.Player('playerBox',{
      // ðŸ‘‡ WICHTIG: No-Cookie Host und origin setzen
      host: 'https://www.youtube-nocookie.com',
      videoId: VIDEO_ID,
      playerVars:{
        autoplay: AUTOPLAY ? 1 : 0,
        playsinline: 1,
        rel: 0,
        modestbranding: 1,
        controls: 1,
        mute: MUTE ? 1 : 0,
        origin: location.origin
      },
      events:{ onReady:onReady, onStateChange:onState, onError:onError } // ðŸ‘ˆ onError ergÃ¤nzt
    });
  }

  function onReady(){
    // Poster bleibt PREROLL ms, dann Autoplay-Versuch (bei MUTE meist erlaubt)
    setTimeout(()=>{
      try{
        if(MUTE && player.mute) player.mute();
        if (AUTOPLAY && player.playVideo) player.playVideo();
      }catch(e){
        showPoster();
      }
    }, PREROLL);
  }

  function onState(e){
    const S = YT.PlayerState;
    if(e.data === S.PLAYING){ showPlayer(); }
    if(e.data === S.BUFFERING || e.data === S.UNSTARTED){ showPoster(); }
    if(e.data === S.ENDED){ showPoster(); }
  }

  function onError(){ // ðŸ‘‡ statt Schwarz wieder Poster zeigen
    showPoster();
  }

  showPoster();
  loadYT();
})();
